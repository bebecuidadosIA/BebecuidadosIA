<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beb√©Food IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; margin: 0; }
        .app-shell { max-width: 450px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 4px 50px rgba(0,0,0,0.05); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // CONFIGURA√á√ïES (URL e Chaves j√° configuradas)
        const SUPABASE_URL = "https://zvdoakrgrgvnhmwlqgnr.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2ZG9ha3Jncmd2bmhtd2xxZ25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDEwMjksImV4cCI6MjA4NjAxNzAyOX0.-wkOsgmKKO0AH2Jo4GHyQcWkJDJwyeAPn_3kb3_4AsI";
        const GEMINI_KEY = "AIzaSyCU_3CjkJXn8TwpPB7TTkvhrkGZQ0wIAmg";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [view, setView] = useState('welcome'); // welcome, login, signup, quiz, home, chat
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            
            // Dados do Beb√© (Quiz)
            const [bebeData, setBebeData] = useState({ nome: '', idade: '', restricoes: '' });
            
            // Chat
            const [chat, setChat] = useState([]);
            const [input, setInput] = useState('');

            useEffect(() => {
                const init = async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        setUser(session.user);
                        // Se logado, vamos para a home (ou quiz se n√£o tiver dados, mas para simplificar, home)
                        setView('home');
                        setChat([{ role: 'bot', text: `Ol√°! Sou a Jeey. Como posso ajudar na alimenta√ß√£o do seu pequeno hoje? ‚ú®` }]);
                    }
                };
                init();
            }, []);

            // FUN√á√ïES DE AUTENTICA√á√ÉO
            const handleAuth = async (e, type) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg('');
                const email = e.target.email.value;
                const password = e.target.password.value;

                try {
                    const { data, error } = type === 'login' 
                        ? await supabase.auth.signInWithPassword({ email, password })
                        : await supabase.auth.signUp({ email, password });

                    if (error) throw error;
                    
                    if (type === 'signup') {
                        setView('quiz'); // Novos usu√°rios v√£o para o Quiz
                    } else {
                        setUser(data.user);
                        setView('home');
                    }
                } catch (err) {
                    setErrorMsg(err.message === "Invalid login credentials" ? "E-mail ou senha incorretos." : err.message);
                } finally {
                    setLoading(false);
                }
            };

            // INTELIG√äNCIA ARTIFICIAL
            const askJeey = async () => {
                if (!input.trim() || loading) return;
                const userMsg = input;
                setChat(prev => [...prev, { role: 'user', text: userMsg }]);
                setInput('');
                setLoading(true);

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userMsg }] }],
                            systemInstruction: { parts: [{ text: `√âs a Jeey, assistente de nutri√ß√£o infantil. O beb√© chama-se ${bebeData.nome}, tem ${bebeData.idade} e estas restri√ß√µes: ${bebeData.restricoes}. Responde de forma carinhosa em PT-PT.` }] }
                        })
                    });
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe mam√£, pode repetir?";
                    setChat(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (e) {
                    setChat(prev => [...prev, { role: 'bot', text: "Erro de conex√£o. Tente novamente!" }]);
                } finally {
                    setLoading(false);
                }
            };

            // --- TELAS ---

            if (view === 'welcome') return (
                <div className="app-shell items-center justify-center p-8 bg-emerald-50 text-center fade-in">
                    <div className="text-7xl mb-6">üë∂</div>
                    <h1 className="text-4xl font-extrabold text-emerald-900 mb-2">Beb√©Food IA</h1>
                    <p className="text-emerald-600 mb-12 font-medium leading-relaxed">O guia inteligente para a melhor fase do seu beb√©.</p>
                    <div className="w-full space-y-4">
                        <button onClick={() => setView('login')} className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-extrabold shadow-lg shadow-emerald-200">Entrar na Minha Conta</button>
                        <button onClick={() => setView('signup')} className="w-full bg-white text-emerald-500 py-5 rounded-2xl font-extrabold border-2 border-emerald-100">Criar Acesso Agora</button>
                    </div>
                </div>
            );

            if (view === 'login' || view === 'signup') return (
                <div className="app-shell p-8 fade-in">
                    <button onClick={() => setView('welcome')} className="text-emerald-500 font-bold mb-10 text-xs">‚Üê VOLTAR</button>
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-8">{view === 'login' ? 'Bem-vinda de volta!' : 'Come√ßar Jornada'}</h2>
                    <form onSubmit={(e) => handleAuth(e, view)} className="space-y-4">
                        <input name="email" type="email" placeholder="Seu melhor e-mail" className="w-full p-5 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500" required />
                        <input name="password" type="password" placeholder="Sua senha secreta" className="w-full p-5 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500" required />
                        {errorMsg && <p className="text-red-500 text-xs font-bold px-2">{errorMsg}</p>}
                        <button type="submit" disabled={loading} className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-extrabold shadow-lg mt-4 disabled:opacity-50">
                            {loading ? 'A carregar...' : 'Continuar'}
                        </button>
                    </form>
                </div>
            );

            if (view === 'quiz') return (
                <div className="app-shell p-8 fade-in">
                    <div className="w-full bg-gray-100 h-2 rounded-full mb-10"><div className="bg-emerald-500 h-2 w-2/3 rounded-full"></div></div>
                    <h2 className="text-2xl font-extrabold text-gray-900 mb-2">Personalizar Plano</h2>
                    <p className="text-gray-500 text-sm mb-8">Diga-nos um pouco sobre o seu pequeno tesouro.</p>
                    <div className="space-y-6">
                        <div>
                            <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1">Nome do Beb√©</label>
                            <input value={bebeData.nome} onChange={e => setBebeData({...bebeData, nome: e.target.value})} className="w-full p-5 bg-gray-50 border rounded-2xl mt-2 outline-none" placeholder="Ex: Martim" />
                        </div>
                        <div>
                            <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1">Idade do Beb√©</label>
                            <select value={bebeData.idade} onChange={e => setBebeData({...bebeData, idade: e.target.value})} className="w-full p-5 bg-gray-50 border rounded-2xl mt-2 outline-none appearance-none">
                                <option value="">Selecionar...</option>
                                <option value="6 meses">6 meses</option>
                                <option value="7 a 9 meses">7 a 9 meses</option>
                                <option value="10 a 12 meses">10 a 12 meses</option>
                                <option value="Mais de 1 ano">Mais de 1 ano</option>
                            </select>
                        </div>
                        <button onClick={() => setView('home')} className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-extrabold shadow-lg mt-4">Ver Meu Plano Personalizado ‚ú®</button>
                    </div>
                </div>
            );

            if (view === 'home') return (
                <div className="app-shell bg-gray-50">
                    <header className="p-6 bg-white border-b flex justify-between items-center">
                        <div>
                            <p className="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Plano do {bebeData.nome || 'Beb√©'}</p>
                            <h2 className="font-extrabold text-lg text-gray-800">Ol√°, Mam√£! üëã</h2>
                        </div>
                        <button onClick={() => setView('welcome')} className="text-[10px] text-gray-300 font-bold uppercase underline">Sair</button>
                    </header>
                    <main className="p-6 space-y-6 overflow-y-auto">
                        <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-emerald-100">
                            <h3 className="font-bold text-lg italic mb-2">Dica Personalizada ‚ú®</h3>
                            <p className="text-sm opacity-90 font-medium">Como o {bebeData.nome || 'seu beb√©'} tem {bebeData.idade || '6 meses'}, foque em texturas macias e sabores naturais hoje!</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100 text-center shadow-sm active:scale-95 transition-all">
                                <span className="text-4xl">üìÖ</span>
                                <p className="text-[10px] font-black text-gray-400 uppercase mt-2 tracking-widest">Card√°pio</p>
                            </div>
                            <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100 text-center shadow-sm active:scale-95 transition-all">
                                <span className="text-4xl">ü•ò</span>
                                <p className="text-[10px] font-black text-gray-400 uppercase mt-2 tracking-widest">Receitas</p>
                            </div>
                        </div>
                        <button onClick={() => setView('chat')} className="w-full bg-emerald-500 p-6 rounded-[2.5rem] flex items-center gap-4 shadow-xl shadow-emerald-100 active:scale-95 transition-all">
                            <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-2xl">üí¨</div>
                            <div className="text-left text-white">
                                <p className="font-extrabold text-sm">Falar com Jeey IA</p>
                                <p className="text-[10px] font-bold opacity-80 uppercase tracking-widest">Assistente Nutricional</p>
                            </div>
                        </button>
                    </main>
                </div>
            );

            if (view === 'chat') return (
                <div className="app-shell h-screen overflow-hidden flex flex-col">
                    <header className="p-6 bg-white border-b flex justify-between items-center">
                        <button onClick={() => setView('home')} className="text-emerald-500 font-bold text-xs uppercase tracking-tighter">‚Üê Painel</button>
                        <h2 className="font-extrabold text-lg text-emerald-600">Jeey IA</h2>
                        <div className="w-8"></div>
                    </header>
                    <main className="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                        {chat.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`p-4 rounded-3xl max-w-[85%] text-sm font-medium shadow-sm ${m.role === 'user' ? 'bg-emerald-500 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none'}`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        {loading && <p className="text-[9px] font-black text-emerald-500 uppercase tracking-widest animate-pulse px-4">Jeey est√° a escrever...</p>}
                    </main>
                    <footer className="p-4 bg-white border-t flex gap-2">
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && askJeey()} placeholder="Sua d√∫vida..." className="flex-1 bg-gray-50 p-5 rounded-3xl text-sm outline-none border-none" />
                        <button onClick={askJeey} className="bg-emerald-500 text-white w-14 rounded-3xl shadow-lg shadow-emerald-100 flex items-center justify-center text-xl active:scale-90 transition-all">üöÄ</button>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
