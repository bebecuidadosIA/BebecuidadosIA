import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged, 
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  updateDoc, 
  arrayUnion, 
  arrayRemove 
} from 'firebase/firestore';
import { 
  ChefHat, 
  MessageCircle, 
  UserRound, 
  Heart, 
  CheckCircle2, 
  Home, 
  Search, 
  Plus, 
  PlayCircle, 
  Mic, 
  Settings,
  Baby,
  Stethoscope,
  ArrowRight
} from 'lucide-react';

// --- CONFIGURA√á√ïES ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'bebefood-ia-v1';
const GEMINI_API_KEY = ""; // Chave injetada no ambiente

// Mock de Receitas Iniciais
const INITIAL_RECIPES = [
  { id: '1', title: 'Papa de Ab√≥bora e Frango', time: '20 min', age: '6+ meses', category: 'Almo√ßo', video: true, audio: true },
  { id: '2', title: 'Pur√© de Ma√ß√£ e Canela', time: '10 min', age: '4+ meses', category: 'Lanche', video: false, audio: true },
  { id: '3', title: 'Creme de Br√≥colos e Batata', time: '25 min', age: '7+ meses', category: 'Jantar', video: true, audio: false },
  { id: '4', title: 'Papinha de Banana com Aveia', time: '5 min', age: '6+ meses', category: 'Pequeno-almo√ßo', video: false, audio: true },
];

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('welcome'); // welcome, auth, quiz, main
  const [activeTab, setActiveTab] = useState('home'); // home, receitas, feitos, favoritos, profissionais, jeey
  const [userData, setUserData] = useState({ nome: '', idadeBebe: '', favoritos: [], feitos: [] });
  const [loading, setLoading] = useState(true);
  const [chat, setChat] = useState([{ role: 'bot', text: 'Ol√° mam√£! Sou a Jeey. Como posso ajudar o seu pequeno hoje? ‚ú®' }]);
  const [input, setInput] = useState('');

  // 1. Autentica√ß√£o e Persist√™ncia
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error", err);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        loadUserData(currentUser.uid);
      } else {
        setLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  // 2. Carregar Dados do Firestore
  const loadUserData = async (uid) => {
    const userRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      setUserData(snap.data());
      setView('main');
    } else {
      setView('quiz');
    }
    setLoading(false);
  };

  // 3. Guardar Quiz
  const saveQuiz = async (e) => {
    e.preventDefault();
    if (!user) return;
    const formData = new FormData(e.target);
    const data = {
      nome: formData.get('nome'),
      idadeBebe: formData.get('idade'),
      favoritos: [],
      feitos: []
    };
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), data);
    setUserData(data);
    setView('main');
  };

  // 4. L√≥gica de Favoritos e Feitos
  const toggleFeature = async (recipeId, collection) => {
    if (!user) return;
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
    const isPresent = userData[collection].includes(recipeId);
    
    const update = isPresent 
      ? { [collection]: arrayRemove(recipeId) } 
      : { [collection]: arrayUnion(recipeId) };
    
    await updateDoc(userRef, update);
    setUserData(prev => ({
      ...prev,
      [collection]: isPresent 
        ? prev[collection].filter(id => id !== recipeId) 
        : [...prev[collection], recipeId]
    }));
  };

  // 5. Intelig√™ncia Artificial (Jeey)
  const askJeey = async () => {
    if (!input.trim() || !user) return;
    const prompt = input;
    setChat(prev => [...prev, { role: 'user', text: prompt }]);
    setInput('');
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: `√âs a Jeey, assistente do Beb√©Food IA. O beb√© chama-se ${userData.nome} e tem ${userData.idadeBebe}. Responde com empatia, foco em nutri√ß√£o e sempre em Portugu√™s de Portugal. Se a d√∫vida for m√©dica grave, sugere consultar um dos profissionais do app.` }] }
        })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Ups, tive um solu√ßo. Podes repetir?";
      setChat(prev => [...prev, { role: 'bot', text }]);
    } catch (err) {
      setChat(prev => [...prev, { role: 'bot', text: "Lamento mam√£, estou com dificuldades de liga√ß√£o." }]);
    }
  };

  if (loading) return <div className="h-screen flex items-center justify-center bg-emerald-50 text-emerald-600 font-bold">Carregando Beb√©Food...</div>;

  // --- SUB-COMPONENTES ---

  const RecipeCard = ({ recipe }) => (
    <div className="bg-white rounded-3xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition-all">
      <div className="flex justify-between items-start mb-3">
        <div className="bg-emerald-50 text-emerald-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-tighter">
          {recipe.age}
        </div>
        <div className="flex gap-1">
          <button onClick={() => toggleFeature(recipe.id, 'favoritos')} className={`${userData.favoritos.includes(recipe.id) ? 'text-red-500' : 'text-gray-300'}`}>
            <Heart size={18} fill={userData.favoritos.includes(recipe.id) ? "currentColor" : "none"} />
          </button>
        </div>
      </div>
      <h4 className="font-bold text-gray-800 leading-tight mb-2">{recipe.title}</h4>
      <div className="flex items-center gap-4 text-[10px] text-gray-400 font-medium mb-4">
        <span className="flex items-center gap-1"><Home size={12}/> {recipe.time}</span>
        {recipe.video && <span className="flex items-center gap-1 text-blue-500"><PlayCircle size={12}/> V√≠deo</span>}
        {recipe.audio && <span className="flex items-center gap-1 text-purple-500"><Mic size={12}/> √Åudio</span>}
      </div>
      <button 
        onClick={() => toggleFeature(recipe.id, 'feitos')}
        className={`w-full py-2 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${userData.feitos.includes(recipe.id) ? 'bg-emerald-500 text-white' : 'bg-gray-50 text-gray-400 border border-gray-100'}`}
      >
        {userData.feitos.includes(recipe.id) ? <><CheckCircle2 size={14}/> Feito!</> : 'Marcar como Feito'}
      </button>
    </div>
  );

  // --- VIEWS ---

  if (view === 'welcome') return (
    <div className="app-shell min-h-screen bg-emerald-50 flex flex-col items-center justify-center p-8 text-center">
      <div className="w-24 h-24 bg-white rounded-[2.5rem] shadow-xl flex items-center justify-center text-5xl mb-8 animate-bounce">üë∂</div>
      <h1 className="text-4xl font-extrabold text-emerald-900 mb-4 tracking-tight">Beb√©Food IA</h1>
      <p className="text-emerald-700 mb-12 font-medium leading-relaxed">Apoio nutricional inteligente para o seu maior tesouro por apenas <span className="font-bold underline">13‚Ç¨/m√™s</span>.</p>
      <button onClick={() => setView('auth')} className="w-full max-w-xs bg-emerald-500 text-white py-5 rounded-2xl font-bold shadow-xl shadow-emerald-200 active:scale-95 transition-all">Come√ßar Agora</button>
    </div>
  );

  if (view === 'quiz') return (
    <div className="app-shell min-h-screen bg-white p-8">
      <div className="w-full bg-gray-100 h-2 rounded-full mb-10"><div className="bg-emerald-500 h-2 w-1/3 rounded-full"></div></div>
      <h2 className="text-2xl font-black text-gray-900 mb-2">Quase l√°, mam√£!</h2>
      <p className="text-gray-500 text-sm mb-10">Personalize a experi√™ncia para o seu beb√©.</p>
      <form onSubmit={saveQuiz} className="space-y-6">
        <div>
          <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Nome do Beb√©</label>
          <input name="nome" required className="w-full p-5 bg-gray-50 border-none rounded-2xl mt-2 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Ex: Martim" />
        </div>
        <div>
          <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Idade do Beb√©</label>
          <select name="idade" required className="w-full p-5 bg-gray-50 border-none rounded-2xl mt-2 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none">
            <option value="6 meses">6 meses (In√≠cio)</option>
            <option value="7-9 meses">7-9 meses</option>
            <option value="10-12 meses">10-12 meses</option>
            <option value="1-2 anos">1-2 anos</option>
          </select>
        </div>
        <button type="submit" className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-bold shadow-lg mt-6">Ativar Plano Premium</button>
      </form>
    </div>
  );

  return (
    <div className="app-shell flex flex-col h-screen bg-gray-50 overflow-hidden">
      {/* HEADER */}
      <header className="bg-white px-6 py-5 flex justify-between items-center border-b sticky top-0 z-20">
        <div>
          <p className="text-[9px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-0.5">Membro VIP</p>
          <h2 className="font-extrabold text-gray-900 leading-none flex items-center gap-2">
            Ol√°, Mam√£! <span className="text-xl">üëã</span>
          </h2>
        </div>
        <div className="flex gap-2">
           <button className="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600"><Settings size={18}/></button>
        </div>
      </header>

      {/* CONTE√öDO PRINCIPAL */}
      <main className="flex-1 overflow-y-auto p-6 pb-24 hide-scrollbar">
        
        {/* VIEW: HOME */}
        {activeTab === 'home' && (
          <div className="space-y-6 animate-in">
            <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-emerald-100 relative overflow-hidden">
              <div className="relative z-10">
                <h3 className="font-bold text-2xl mb-2 italic">Dica da Jeey ‚ú®</h3>
                <p className="text-sm opacity-90 leading-relaxed">O {userData.nome} est√° a crescer! Como estamos no Inverno, que tal uma papa de legumes quente hoje?</p>
              </div>
              <div className="absolute -right-8 -bottom-8 text-white/10 text-9xl font-black">ü•£</div>
            </div>

            <div className="grid grid-cols-2 gap-4">
               <button onClick={() => setActiveTab('receitas')} className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col items-center">
                  <div className="w-12 h-12 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-500 mb-3"><ChefHat size={24}/></div>
                  <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Receitas</span>
               </button>
               <button onClick={() => setActiveTab('profissionais')} className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col items-center">
                  <div className="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-500 mb-3"><Stethoscope size={24}/></div>
                  <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Profissionais</span>
               </button>
            </div>

            <h4 className="font-black text-[10px] text-gray-400 uppercase tracking-[0.2em] pt-4">Sugest√£o Baseada no Clima</h4>
            <RecipeCard recipe={INITIAL_RECIPES[0]} />
          </div>
        )}

        {/* VIEW: RECEITAS / FEITOS / FAVORITOS */}
        {(activeTab === 'receitas' || activeTab === 'feitos' || activeTab === 'favoritos') && (
          <div className="space-y-6 animate-in">
             <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                {['receitas', 'favoritos', 'feitos'].map(t => (
                  <button 
                    key={t}
                    onClick={() => setActiveTab(t)}
                    className={`px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === t ? 'bg-emerald-500 text-white' : 'bg-white text-gray-400 border'}`}
                  >
                    {t}
                  </button>
                ))}
             </div>
             
             <div className="grid grid-cols-1 gap-4">
                {INITIAL_RECIPES
                  .filter(r => {
                    if (activeTab === 'favoritos') return userData.favoritos.includes(r.id);
                    if (activeTab === 'feitos') return userData.feitos.includes(r.id);
                    return true;
                  })
                  .map(r => <RecipeCard key={r.id} recipe={r} />)
                }
                {activeTab !== 'receitas' && INITIAL_RECIPES.filter(r => activeTab === 'favoritos' ? userData.favoritos.includes(r.id) : userData.feitos.includes(r.id)).length === 0 && (
                  <div className="text-center py-20 opacity-30">
                    <Search size={48} className="mx-auto mb-4" />
                    <p className="font-bold">Nada por aqui ainda...</p>
                  </div>
                )}
             </div>
          </div>
        )}

        {/* VIEW: PROFISSIONAIS */}
        {activeTab === 'profissionais' && (
          <div className="space-y-4 animate-in">
             <h3 className="text-xl font-black text-gray-900">Nossa Equipa</h3>
             {[
               { name: 'Dr. Ricardo Silva', role: 'Pediatra', img: 'ü©∫' },
               { name: 'Dra. Ana Mota', role: 'Nutricionista Infantil', img: 'üçé' },
               { name: 'Enf. Carla Santos', role: 'Apoio √† Amamenta√ß√£o', img: 'ü§±' }
             ].map((p, i) => (
               <div key={i} className="bg-white p-5 rounded-3xl border border-gray-100 flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-2xl">{p.img}</div>
                    <div>
                      <p className="font-bold text-gray-800">{p.name}</p>
                      <p className="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">{p.role}</p>
                    </div>
                  </div>
                  <button className="bg-emerald-50 text-emerald-600 p-3 rounded-xl"><ArrowRight size={18}/></button>
               </div>
             ))}
          </div>
        )}

        {/* VIEW: JEEY (CHAT) */}
        {activeTab === 'jeey' && (
          <div className="flex flex-col h-[calc(100vh-220px)] animate-in">
             <div className="flex-1 overflow-y-auto space-y-4 pr-1 hide-scrollbar pb-10">
                {chat.map((m, i) => (
                  <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`p-4 rounded-[1.8rem] max-w-[85%] text-sm font-medium shadow-sm leading-relaxed ${m.role === 'user' ? 'bg-emerald-500 text-white rounded-tr-none' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none'}`}>
                      {m.text}
                    </div>
                  </div>
                ))}
             </div>
             <div className="fixed bottom-24 left-6 right-6 flex gap-2">
                <input 
                  value={input} 
                  onChange={e => setInput(e.target.value)} 
                  onKeyPress={e => e.key === 'Enter' && askJeey()}
                  placeholder="Pergunta √† Jeey..." 
                  className="flex-1 bg-white border border-gray-200 p-5 rounded-[1.5rem] text-sm shadow-xl outline-none" 
                />
                <button onClick={askJeey} className="bg-emerald-500 text-white w-14 h-14 rounded-[1.5rem] shadow-xl flex items-center justify-center">üöÄ</button>
             </div>
          </div>
        )}

      </main>

      {/* NAVEGA√á√ÉO INFERIOR */}
      <nav className="bg-white border-t px-6 py-3 flex justify-between items-center fixed bottom-0 left-0 right-0 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'home' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <Home size={22} fill={activeTab === 'home' ? "currentColor" : "none"} />
          <span className="text-[8px] font-black uppercase tracking-widest">In√≠cio</span>
        </button>
        <button onClick={() => setActiveTab('receitas')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'receitas' || activeTab === 'feitos' || activeTab === 'favoritos' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <ChefHat size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Receitas</span>
        </button>
        <button onClick={() => setActiveTab('jeey')} className={`relative -top-6 bg-emerald-500 text-white w-16 h-16 rounded-[2rem] shadow-xl shadow-emerald-200 flex items-center justify-center border-4 border-white transition-all ${activeTab === 'jeey' ? 'rotate-12 scale-110' : ''}`}>
          <MessageCircle size={28} />
        </button>
        <button onClick={() => setActiveTab('profissionais')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'profissionais' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <Stethoscope size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Equipa</span>
        </button>
        <button className="flex flex-col items-center gap-1 text-gray-300">
          <UserRound size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Conta</span>
        </button>
      </nav>
    </div>
  );
}
