import React, { useState, useEffect } from 'react';
import { 
  ChefHat, 
  MessageCircle, 
  UserRound, 
  Heart, 
  CheckCircle2, 
  Home, 
  Search, 
  Settings,
  Baby,
  Stethoscope,
  ArrowRight,
  PlayCircle,
  Mic,
  Send
} from 'lucide-react';

/**
 * Nota: Como o ambiente n√£o permite o import direto de '@supabase/supabase-js',
 * utilizamos a vers√£o global carregada via script ou injetada.
 * Para este ambiente, assumimos o uso de uma abordagem compat√≠vel.
 */

// --- CONFIGURA√á√ÉO SUPABASE ---
const supabaseUrl = typeof __supabase_url !== 'undefined' ? __supabase_url : '';
const supabaseKey = typeof __supabase_key !== 'undefined' ? __supabase_key : '';

// Mock do cliente Supabase para garantir que a UI n√£o quebra se o m√≥dulo falhar
const supabase = (typeof window !== 'undefined' && window.supabase) 
  ? window.supabase.createClient(supabaseUrl, supabaseKey)
  : {
      auth: { getSession: async () => ({ data: { session: null } }), onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } }) },
      from: () => ({ select: () => ({ eq: () => ({ single: () => ({ data: null, error: null }) }) }), upsert: async () => ({ error: null }) })
    };

// --- CONFIGURA√á√ÉO GEMINI ---
const GEMINI_API_KEY = ""; // Injetada pelo ambiente

const INITIAL_RECIPES = [
  { id: '1', title: 'Papa de Ab√≥bora e Frango', time: '20 min', age: '6+ meses', category: 'Almo√ßo', video: true, audio: true, icon: 'ü•ï' },
  { id: '2', title: 'Pur√© de Ma√ß√£ e Canela', time: '10 min', age: '4+ meses', category: 'Lanche', video: false, audio: true, icon: 'üçé' },
  { id: '3', title: 'Creme de Br√≥colos e Batata', time: '25 min', age: '7+ meses', category: 'Jantar', video: true, audio: false, icon: 'ü•¶' },
  { id: '4', title: 'Papinha de Banana com Aveia', time: '5 min', age: '6+ meses', category: 'Pequeno-almo√ßo', video: false, audio: true, icon: 'üçå' },
];

export default function App() {
  const [session, setSession] = useState(null);
  const [view, setView] = useState('loading'); // loading, welcome, quiz, main
  const [activeTab, setActiveTab] = useState('home');
  const [userData, setUserData] = useState({ nome: '', idadebebe: '', favoritos: [], feitos: [] });
  const [chat, setChat] = useState([{ role: 'bot', text: 'Ol√° mam√£! Sou a Jeey. Como posso ajudar o seu pequeno hoje? ‚ú®' }]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);

  // 1. Inicializa√ß√£o e Sess√£o
  useEffect(() => {
    const checkSession = async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        setSession(session);
        if (session) await loadProfile(session.user.id);
        else setView('welcome');
      } catch (e) {
        setView('welcome');
      }
    };

    checkSession();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      if (session) loadProfile(session.user.id);
      else setView('welcome');
    });

    return () => subscription.unsubscribe();
  }, []);

  // 2. Carregar Perfil
  const loadProfile = async (userId) => {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (data) {
        setUserData(data);
        setView('main');
      } else {
        setView('quiz');
      }
    } catch (e) {
      setView('quiz');
    }
  };

  // 3. Login Simulado / In√≠cio
  const handleStart = () => {
    setView('quiz');
  };

  // 4. Guardar Dados (Upsert)
  const saveQuiz = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const id = session?.user?.id || `anon-${crypto.randomUUID()}`;
    const newData = {
      id: id,
      nome: formData.get('nome'),
      idadebebe: formData.get('idade'),
      favoritos: [],
      feitos: []
    };

    try {
      const { error } = await supabase.from('profiles').upsert(newData);
      if (!error) {
        setUserData(newData);
        setView('main');
      }
    } catch (e) {
      setUserData(newData);
      setView('main');
    }
  };

  // 5. Intelig√™ncia Artificial (Gemini)
  const askJeey = async () => {
    if (!input.trim()) return;
    const userMsg = input;
    setChat(prev => [...prev, { role: 'user', text: userMsg }]);
    setInput('');
    setIsTyping(true);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userMsg }] }],
          systemInstruction: { parts: [{ text: `√âs a Jeey, assistente do Beb√©Food IA. O beb√© chama-se ${userData.nome} e tem ${userData.idadebebe}. Responde com empatia, foco em nutri√ß√£o e sempre em Portugu√™s de Portugal. Respostas curtas, calorosas e profissionais.` }] }
        })
      });
      const data = await response.json();
      const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Ups, tive um solu√ßo. Podes repetir, mam√£?";
      setChat(prev => [...prev, { role: 'bot', text: botText }]);
    } catch (err) {
      setChat(prev => [...prev, { role: 'bot', text: "Lamento mam√£, estou com dificuldades de liga√ß√£o √† rede." }]);
    } finally {
      setIsTyping(false);
    }
  };

  // --- COMPONENTES DE UI ---

  const RecipeCard = ({ recipe }) => (
    <div className="bg-white rounded-[2rem] border border-gray-100 p-5 shadow-sm hover:shadow-md transition-all">
      <div className="flex justify-between items-start mb-4">
        <span className="bg-emerald-50 text-emerald-700 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">
          {recipe.age}
        </span>
        <Heart 
          size={20} 
          className={userData.favoritos?.includes(recipe.id) ? "text-red-500 fill-current" : "text-gray-200"} 
        />
      </div>
      <div className="flex items-center gap-4 mb-4">
        <div className="w-14 h-14 bg-gray-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner">
          {recipe.icon}
        </div>
        <div>
          <h4 className="font-extrabold text-gray-800 leading-tight">{recipe.title}</h4>
          <p className="text-[10px] font-bold text-gray-400 uppercase mt-1">{recipe.time} ‚Ä¢ {recipe.category}</p>
        </div>
      </div>
      <div className="flex gap-2">
        <button className="flex-1 py-3 bg-emerald-500 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-all">
          Ver Receita
        </button>
        <button className="px-4 py-3 bg-gray-50 text-gray-400 rounded-2xl hover:bg-emerald-50 hover:text-emerald-500 transition-colors">
          <CheckCircle2 size={18} />
        </button>
      </div>
    </div>
  );

  // --- RENDERIZA√á√ÉO ---

  if (view === 'loading') return (
    <div className="h-screen flex flex-col items-center justify-center bg-white">
      <div className="w-16 h-16 border-4 border-emerald-100 border-t-emerald-500 rounded-full animate-spin mb-4"></div>
      <p className="text-emerald-600 font-black tracking-widest text-xs">A CARREGAR BEB√âFOOD...</p>
    </div>
  );

  if (view === 'welcome') return (
    <div className="max-w-[450px] mx-auto min-h-screen bg-emerald-50 flex flex-col items-center justify-center p-10 text-center">
      <div className="w-24 h-24 bg-white rounded-[2.5rem] shadow-2xl flex items-center justify-center text-5xl mb-10 animate-bounce">ü•£</div>
      <h1 className="text-4xl font-black text-emerald-900 mb-4 tracking-tight">Beb√©Food IA</h1>
      <p className="text-emerald-700 mb-12 font-medium leading-relaxed px-4">
        Nutri√ß√£o personalizada com intelig√™ncia artificial para o seu beb√©.
      </p>
      <button onClick={handleStart} className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-bold shadow-xl shadow-emerald-200 active:scale-95 transition-all uppercase tracking-widest text-sm">
        Come√ßar Agora
      </button>
      <p className="mt-8 text-[10px] text-emerald-600 font-bold opacity-60 uppercase tracking-widest">Premium: 13‚Ç¨ / m√™s</p>
    </div>
  );

  if (view === 'quiz') return (
    <div className="max-w-[450px] mx-auto min-h-screen bg-white p-8">
      <div className="mb-10">
        <h2 className="text-3xl font-black text-gray-900 mb-2">Bem-vinda!</h2>
        <p className="text-gray-500 text-sm">O Martim ou a Alice? Como se chama o seu tesouro?</p>
      </div>
      <form onSubmit={saveQuiz} className="space-y-8">
        <div>
          <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Nome do Beb√©</label>
          <input name="nome" required className="w-full p-5 bg-gray-50 border-none rounded-2xl mt-2 focus:ring-2 focus:ring-emerald-500 outline-none text-gray-700 font-bold" placeholder="Ex: Martim" />
        </div>
        <div>
          <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Fase do Beb√©</label>
          <select name="idade" className="w-full p-5 bg-gray-50 border-none rounded-2xl mt-2 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none text-gray-700 font-bold">
            <option>Introdu√ß√£o (6 meses)</option>
            <option>7-9 meses</option>
            <option>10-12 meses</option>
            <option>Explorador (+1 ano)</option>
          </select>
        </div>
        <button type="submit" className="w-full bg-emerald-500 text-white py-5 rounded-2xl font-bold shadow-lg shadow-emerald-100 mt-6 uppercase tracking-widest">
          Criar Perfil VIP
        </button>
      </form>
    </div>
  );

  return (
    <div className="max-w-[450px] mx-auto h-screen flex flex-col bg-gray-50 overflow-hidden relative font-sans">
      
      {/* HEADER */}
      <header className="bg-white px-6 py-6 flex justify-between items-center border-b z-20">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg shadow-emerald-100">
            BF
          </div>
          <div>
            <p className="text-[9px] font-black text-emerald-500 uppercase tracking-[0.2em]">Membro Premium</p>
            <h2 className="font-extrabold text-gray-900 leading-none">Ol√°, Mam√£! üëã</h2>
          </div>
        </div>
        <button className="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 hover:text-emerald-500 transition-colors">
          <Settings size={20}/>
        </button>
      </header>

      {/* CONTENT AREA */}
      <main className="flex-1 overflow-y-auto p-6 pb-32 hide-scrollbar">
        
        {activeTab === 'home' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-xl">‚ú®</span>
                  <h3 className="font-bold text-lg italic">Dica da Jeey</h3>
                </div>
                <p className="text-sm opacity-95 leading-relaxed font-medium">
                  {userData.nome ? `O ${userData.nome}` : 'O seu beb√©'} est√° numa fase de crescimento acelerado. A ab√≥bora √© excelente para a vis√£o!
                </p>
              </div>
              <div className="absolute -right-10 -bottom-10 text-white/10 text-[10rem] font-black rotate-12">ü•¶</div>
            </div>

            <div className="grid grid-cols-2 gap-4">
               <button onClick={() => setActiveTab('receitas')} className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col items-center active:scale-95 transition-all">
                 <div className="w-12 h-12 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-500 mb-3"><ChefHat size={24}/></div>
                 <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Receitas</span>
               </button>
               <button onClick={() => setActiveTab('equipa')} className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col items-center active:scale-95 transition-all">
                 <div className="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-500 mb-3"><Stethoscope size={24}/></div>
                 <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Equipa VIP</span>
               </button>
            </div>

            <div className="flex justify-between items-center px-1">
              <h4 className="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Prato do Dia</h4>
              <button className="text-[9px] font-black text-emerald-500 uppercase">Ver Todos</button>
            </div>
            <RecipeCard recipe={INITIAL_RECIPES[0]} />
          </div>
        )}

        {activeTab === 'receitas' && (
          <div className="space-y-4 animate-in slide-in-from-right-4 duration-300">
            <h3 className="text-xl font-black text-gray-900 mb-4">Menu de Nutri√ß√£o</h3>
            <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
              {['Tudo', 'Almo√ßo', 'Lanche', 'Jantar'].map(cat => (
                <button key={cat} className="px-5 py-2 rounded-full bg-white border border-gray-100 text-[10px] font-black uppercase tracking-widest whitespace-nowrap hover:bg-emerald-500 hover:text-white transition-all">
                  {cat}
                </button>
              ))}
            </div>
            {INITIAL_RECIPES.map(r => <RecipeCard key={r.id} recipe={r} />)}
          </div>
        )}

        {activeTab === 'jeey' && (
          <div className="flex flex-col h-[calc(100vh-250px)] animate-in zoom-in-95 duration-300">
            <div className="flex-1 overflow-y-auto space-y-4 pb-16 hide-scrollbar">
              {chat.map((m, i) => (
                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-4 rounded-[1.8rem] text-sm leading-relaxed shadow-sm ${
                    m.role === 'user' ? 'bg-emerald-500 text-white rounded-tr-none' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none font-medium'
                  }`}>
                    {m.text}
                  </div>
                </div>
              ))}
              {isTyping && <div className="text-[10px] font-bold text-emerald-400 animate-pulse ml-2 tracking-widest">A JEEY EST√Å A PENSAR...</div>}
            </div>
            <div className="absolute bottom-28 left-6 right-6 flex gap-2">
              <input 
                value={input}
                onChange={e => setInput(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && askJeey()}
                placeholder="D√∫vida sobre a papa?"
                className="flex-1 bg-white border border-gray-100 p-5 rounded-[1.5rem] text-sm shadow-xl outline-none focus:ring-2 focus:ring-emerald-500/20 transition-all"
              />
              <button onClick={askJeey} className="bg-emerald-500 text-white w-14 h-14 rounded-[1.5rem] flex items-center justify-center shadow-xl shadow-emerald-100 active:scale-90 transition-all">
                <Send size={20} />
              </button>
            </div>
          </div>
        )}

        {activeTab === 'equipa' && (
          <div className="space-y-4 animate-in slide-in-from-left-4 duration-300">
             <h3 className="text-xl font-black text-gray-900 mb-4">Apoio Profissional</h3>
             {[
               { name: 'Dr. Ricardo Silva', role: 'Pediatra (Dispon√≠vel)', icon: 'ü©∫', color: 'bg-blue-50 text-blue-500' },
               { name: 'Dra. Ana Mota', role: 'Nutricionista Infantil', icon: 'üçé', color: 'bg-orange-50 text-orange-500' },
               { name: 'Enf. Carla Maria', role: 'Sono e Amamenta√ß√£o', icon: 'ü§±', color: 'bg-purple-50 text-purple-500' }
             ].map((p, i) => (
               <div key={i} className="bg-white p-5 rounded-[2rem] border border-gray-100 flex items-center justify-between shadow-sm active:bg-gray-50 transition-colors">
                 <div className="flex items-center gap-4">
                   <div className={`w-12 h-12 ${p.color} rounded-2xl flex items-center justify-center text-2xl`}>{p.icon}</div>
                   <div>
                     <p className="font-extrabold text-gray-800">{p.name}</p>
                     <p className="text-[9px] font-black text-emerald-500 uppercase tracking-widest">{p.role}</p>
                   </div>
                 </div>
                 <ArrowRight size={18} className="text-gray-300" />
               </div>
             ))}
             <div className="p-6 bg-emerald-50 rounded-[2rem] border border-emerald-100 mt-6">
                <p className="text-[10px] font-black text-emerald-700 uppercase tracking-widest mb-2 text-center">Precisa de Ajuda Urgente?</p>
                <button className="w-full py-3 bg-white text-emerald-600 rounded-xl font-bold text-xs shadow-sm">Ligar para Linha Sa√∫de 24</button>
             </div>
          </div>
        )}

      </main>

      {/* BOTTOM NAVIGATION */}
      <nav className="absolute bottom-0 left-0 right-0 bg-white border-t px-8 py-4 flex justify-between items-center z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.03)]">
        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'home' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <Home size={22} fill={activeTab === 'home' ? "currentColor" : "none"} />
          <span className="text-[8px] font-black uppercase tracking-widest">In√≠cio</span>
        </button>
        <button onClick={() => setActiveTab('receitas')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'receitas' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <ChefHat size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Menu</span>
        </button>
        <button onClick={() => setActiveTab('jeey')} className={`relative -top-8 bg-emerald-500 text-white w-16 h-16 rounded-[2.2rem] shadow-xl shadow-emerald-200 flex items-center justify-center border-4 border-white active:scale-95 transition-all ${activeTab === 'jeey' ? 'rotate-6' : ''}`}>
          <MessageCircle size={28} />
        </button>
        <button onClick={() => setActiveTab('equipa')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'equipa' ? 'text-emerald-500 scale-110' : 'text-gray-300'}`}>
          <Stethoscope size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Equipa</span>
        </button>
        <button className="flex flex-col items-center gap-1 text-gray-300 opacity-40">
          <UserRound size={22} />
          <span className="text-[8px] font-black uppercase tracking-widest">Perfil</span>
        </button>
      </nav>
    </div>
  );
}
